# Использование и поддержка бота

После прочтения прошлых трёх разделов документации у вас должен быть
рабочий бот. Он отвечает как на запросы адресов, так и на ключевые слова,
выдавая заведения с фотографиями и описаниями. Всё выглядит готовым к запуску.

Но если присмотреться, не всё идеально. Какие-то фотографии отсутствуют,
какие-то важные поля пустуют. Возможно, не все дома и подъезды связаны.
И самое обескураживающее, что эти проблемы будут накапливаться. Давайте
посмотрим на способы поддержки базы, а потом — как работают модераторы
и администратор бота.

## Скрипты

Если запустить `python -m raybot help` из виртуального окружения, вы
получите список команд. Некоторые из них (экспорт и импорт, например)
мы уже использовали. Остальные предназначены для ухода за базой или
для проверки функций. Например, команда `map` сделает фрагмент карты
вокруг объектов с заполненным идентификатором — обычно домов и подъездов.

Собственно, из оставшихся команд (`photos` рассмотрена ниже) не описана
только `missing`. Она выводит количество и список заведений, у которых
не проставлены — отдельно — поля house, keywords, links, tag и hours.
Исправить эти предупреждения можно и из самого бота, просто ища по названиям.
Для полей house и tag списки встроены прямо в бота (см. ниже).

### Лишние фотографии

Фотографии хранятся отдельно от остальной базы, поэтому иногда содержимое
каталога `photo` рассинхронизируется с записями в базе. Узнать о расхождениях
помогает команда `python -m raybot photos`. Она выдаёт список проблем
четырёх видов:

* "Photo not used" — фотографию загрузили, но не прикрепили ни к одному
  заведению. Такое бывает при обновлении фотографий, или когда человек
  не нажал «удали» при редактировании заведения. Эти фотографии, скорее
  всего, можно удалить.
* "Outside photo is missing" — у заведения нет фотографии снаружи.
  Идите и сделайте. Эта проверка встроена и в бот, см. ниже.
* "Missing photo" — пропал файл с фотографией для заведения. Обычно такое
  бывает от опечаток в ручной расстановке атрибутов `photo` и `inside`
  в редакторе точек. Но иногда пропадают и фотографии, загруженные через
  бота. Я такое видел только раз и буду благодарен за помощь в поисках
  причины.
* "Missing photo for predef resp" — один из ответов в файле
  `config/responses.yml` ссылается на файл фотографии, которого нет
  в каталоге `photo`. Поправьте имя файла или загрузите фото
  и перезапустите бота.

### Работа с базой

Важно, что при работающем боте запись в базу не работает. Это не
Postgres и не MySQL: все данные в одном файле, который можно открыть
на запись только один раз. Поэтому если вам нужно поправить набор
экспортированных заведений или просто сделать `update poi set ... where ...`,
остановите бота. Нажмите Ctrl+C или введите `sudo systemctl stop nav_bot`.

Когда операция над заведениями длительная, останавливать бота, разумеется,
нежелательно. Правка заведений может затянуться на пару часов — едва
ли все соседи согласятся подождать. Выход прост: в файле `config/config.yml`
установите ключ `maintenance` в значение `true` и перезапустите бота.
Всё будет как раньше, только создавать и редактировать заведения будет
нельзя.

Закончив правку, остановите бота, импортируйте новый geojson, верните
значение `maintenance: false` и запустите бота обратно.

## Модерирование

Поддерживать базу заведений в актуальном состоянии — титаническая и бесконечная
работа, делать её в одиночку сложно и надоест. Поэтому у бота есть список
модераторов. Ниже разберёмся, как его пополнять, а тут — про то, что можно
делать модераторам и админу, чего нельзя обычным пользователям.

Самое важное — очередь изменений. Когда пользователи правят заведения,
эти правки не сразу падают в базу, а добавляются в очередь. Вы увидите
её, введя команду `/queue`. Сообщения в неё бывают трёх видов:

* Запрос на изменение одного поля — вам покажут старое и предложенное
  значения, выберите одно из двух.
* Запрос на добавление заведения — оно уже в базе и в поиске, но помечено
  как не проверенное. Посмотрите на его поля, заполните пропуски, если есть,
  и нажмите «Проверено».
* Сообщение в контексте заведения — обычно просьба что-то уточнить.
  Выполните просьбу, если можете, и удаляйте сообщение.

Проверяйте очередь время от времени, потому что напоминания о ней ещё
не сделаны.

Кроме того, модераторы получают сообщения, которые пользователи шлют
командой `/msg`. Получив такое, просто ответьте на него с цитированием,
и отправитель получит ответ. Так можно общаться довольно долго, с фоточками
и стикерами. Не злоупотребляйте, потому что все остальные модераторы получают
уведомления, что вы отвечаете на сообщения.

наконец, удаление заведений. Из бота их можно удалить формально: в базе
они остаются, но у них непустое поле причины удаления. Модераторы
могут восстановить удалённое командой `/undelete` (она будет в карточке
редактора). И могут удалить запись об удалённом заведении навсегда,
введя `/delete` для уже удалённого заведения.

Список удалённых заведений выводится по команде `/deleted`, так же
как список недавно добавленных — по `/last`. Эти команды доступны
всем, не только модераторам.

### Панель администратора

Модераторы и администратор получат ответ на команду `/admin`: там
будут несколько кнопок для ухода за базой данных.

* «Перестроить индекс» — обычно не нужно, но иногда индекс поиска
  рассинхронизируется с содержимым таблицы заведений. Выражается это
  в пропаже заведений из поиска, или в появлении удалённых заведений.
  Если столкнётесь с таким, сообщите в Issues этого репозитория.
* «Нет адреса», «нет фото», «нет тега» — выдаёт список заведений
  с пустыми полями, которые не должны быть пустыми.

И пара кнопок, которые доступны только администратору:

* «Модераторы» — после нажатия этой кнопки перешлите боту сообщение
  от человека, чтобы сделать её/его модератором. Она/он получит
  уведомление, так что сохранить это в секрете не получится. Отсюда
  же можно разжаловать из модераторов.
* «Дедубл. фото» — иногда несколько заведений имеют один и тот же
  вход. Соответственно, одну и ту же фотографию входа. Телеграм
  понимает, когда вы прикрепляете одну и ту же фоточку, и не обрабатывает
  её повторно. А вот бот скачивает то же самое заново. Эта кнопка
  пройдётся по всем фоточкам на диске и удалит дубликаты. Заведения
  в базе после этого будут ссылаться на одну и ту же фотографию.
* «Подчистить фото» — удалит все фотографии, на которые не ссылается
  ни одно заведение из базы. Если вы используете для заведений
  редактор точек, то подождите жать эту кнопку, пока все файлы из
  каталога `photo` не найдут применение.
* «Аудит» — список последних изменений базы заведений.

### Логи

Главным инструментом, доступным только администратору, остаются файлы
конфигурации, файл базы данных и логи. Про первые вы читали во второй главе.
А какие логи доступны? Их три, каждый является TSV-файлом, т.е. таблицей,
в которой значения в строках разделены символом табуляции.

* `access.log` — точное время и идентификатор пользователя, обратившегося
  к боту. Третьим значение записан вид запроса (сообщение, команда или callback),
  но от него немного пользы.
* `poi.log` — дата, идентификатор и название POI (дома, подъезда, магазина,
  заведения, организации), которое показали пользователю.
* `search.log` — дата, сообщение от пользователя, ключевые слова, на которые
  бот разбил это сообщение, и результат поиска.

**Теперь вы всё знаете о своём районном боте. Не забудьте прорекламировать
его как можно шире! Столкнётесь с проблемами — [пишите](https://github.com/Zverik/bot_na_rayone/issues).**
